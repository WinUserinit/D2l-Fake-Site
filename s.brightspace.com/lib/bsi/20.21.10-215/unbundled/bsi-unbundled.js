import"./colors.js";import{f as e,p as t}from"./number.js";import{f as r,p as s}from"./dateTime.js";import{d as o}from"./index.js";import"./d2lfetch-auth-framed.js";import{a as n}from"./d2lfetch-auth.js";import{s as i}from"./settings.js";import{a}from"./announce.js";import{c as l,s as c}from"./dismissible.js";import{p as h,r as u}from"./provider-mixin.js";import"./common.js";import"./boot.js";const d=new class{constructor(){this._inflightRequests={}}dedupe(e,t){if(!1==e instanceof Request)return Promise.reject(new TypeError("Invalid request argument supplied; must be a valid window.Request object."));if("GET"!==e.method&&"HEAD"!==e.method&&"OPTIONS"!==e.method)return t(e);const r=this._getKey(e);let s=!1;if(!this._inflightRequests[r]){const t=e.signal&&"function"==typeof e.signal.addEventListener&&window.AbortController?new AbortController:void 0,o=new Request(e,{signal:t?t.signal:void 0});this._inflightRequests[r]={inflightRequest:o,abortController:t,dedupedRequests:[],nextReqId:0},s=!0}const o=new Promise(((t,s)=>{const o=this._inflightRequests[r],n=o.nextReqId++,i={resolvers:{resolve:t,reject:s},reqId:n};if(o.dedupedRequests.push(i),e.signal){const t=(e,t,r)=>{const o=()=>{e.removeEventListener("abort",o);const n=this._inflightRequests[t];if(!n)return;const i=n.dedupedRequests.findIndex((e=>e.reqId===r));i<0||(n.dedupedRequests.splice(i,1),0===n.dedupedRequests.length&&n.abortController&&n.abortController.abort(),s(new DOMException("Request was aborted.","AbortError")))};i.removeAbortListener=()=>e.removeEventListener("abort",o),e.addEventListener("abort",o)};t(e.signal,r,n)}}));return s?(t(this._inflightRequests[r].inflightRequest).then((e=>{const t=this._inflightRequests[r].dedupedRequests;delete this._inflightRequests[r];const s=t.length>1?this._clone(e):e;for(const e of t)"function"==typeof e.removeAbortListener&&e.removeAbortListener(),e.resolvers.resolve(s)}),(e=>{const t=this._inflightRequests[r].dedupedRequests;delete this._inflightRequests[r];for(const r of t)"function"==typeof r.removeAbortListener&&r.removeAbortListener(),r.resolvers.reject(e)})),o):o}_getKey(e){return e.headers.has("Authorization")?e.url+e.headers.get("Authorization"):e.url}_clone(e){return e.text().then((function(t){return e.json=function(){return Promise.resolve(JSON.parse(t))},e.text=function(){return Promise.resolve(t)},e.arrayBuffer=function(){return Promise.reject(new Error("dedupe middleware cannot be used with arrayBuffer response bodies"))},e.blob=function(){return Promise.reject(new Error("dedupe middleware cannot be used with blob response bodies"))},e.formData=function(){return Promise.reject(new Error("dedupe middleware cannot be used with formData response bodies"))},e}))}};const g=new class{constructor(){this._simplyCachedRequests=this._simplyCachedRequests||[]}cache(e,t,r){let s=!1,o=!1,n=r&&r.cacheLengthInSeconds?r.cacheLengthInSeconds:120;const i=r&&Array.isArray(r.methods)?r.methods:["GET","HEAD","OPTIONS"];if(!1==e instanceof Request)return Promise.reject(new TypeError("Invalid request argument supplied; must be a valid window.Request object."));if(!i.includes(e.method))return t?t(e):Promise.resolve(e);const a=this._getKey(e);if(e.headers.has("cache-control")){const t=function(e){if("string"!=typeof e)return null;var t={},r=e.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(function(e,r,s,o){var n=s||o;return t[r]=!n||n.toLowerCase(),""}));if(t["max-age"])try{var s=parseInt(t["max-age"],10);if(isNaN(s))return null;t["max-age"]=s}catch(r){}return r?null:t}(e.headers.get("cache-control"));s=!!t["no-cache"],o=!!t["no-store"],n=t["max-age"]?t["max-age"]:n}if(s&&delete this._simplyCachedRequests[a],this._simplyCachedRequests[a]){const e=Date.now();if(this._simplyCachedRequests[a].cacheExpires>=e&&this._simplyCachedRequests[a].cacheSetAt+1e3*n>=e){if(this._simplyCachedRequests[a].response instanceof Response)return Promise.resolve(this._simplyCachedRequests[a].response)}else delete this._simplyCachedRequests[a]}if(!t)return Promise.resolve(e);const l=t(e);return l&&l instanceof Promise&&!o?l.then(this._clone).then(function(e){const t=Date.now();return this._simplyCachedRequests[a]={cacheSetAt:t,cacheExpires:t+1e3*n,response:e},e}.bind(this)):l}_getKey(e){const t=e.method+e.url;return e.headers.has("Authorization")?t+e.headers.get("Authorization"):t}_clone(e){return e instanceof Response==!1?Promise.resolve(e):e.text().then((function(t){return e.json=function(){return Promise.resolve(JSON.parse(t))},e.text=function(){return Promise.resolve(t)},e.arrayBuffer=function(){return Promise.reject(new Error("simple-cache middleware cannot be used with arrayBuffer response bodies"))},e.blob=function(){return Promise.reject(new Error("simple-cache middleware cannot be used with blob response bodies"))},e.formData=function(){return Promise.reject(new Error("simple-cache middleware cannot be used with formData response bodies"))},e}))}};function m(e){const t=this;let r={start:{time:performance.now(),x:e.touches[0].clientX,y:e.touches[0].clientY}};const s=()=>{r=null,t.removeEventListener("touchend",n),t.removeEventListener("touchermove",i),t.removeEventListener("touchcancel",o)},o=()=>{s()},n=()=>{if(!r||!r.end)return;const e=performance.now()-r.start.time;if(e>2e3)return void s();const o=r.end.x-r.start.x,n=r.end.y-r.start.y;let i=Math.atan(Math.abs(o)/Math.abs(n));n>0&&o>0?i=57.3*(Math.PI-i):n>0&&o<0?i=57.3*(Math.PI+i):n<0&&o>0?i*=57.3:n<0&&o<0&&(i=57.3*(2*Math.PI-i));let a="none";Math.abs(o)>=30&&(i>205&&i<335?a="left":i>25&&i<155&&(a="right"));let l="none";Math.abs(n)>=30&&(i>295||i<65?l="up":i>115&&i<245&&(l="down")),t.dispatchEvent(new CustomEvent("d2l-gesture-swipe",{detail:{distance:{x:o,y:n},direction:{angle:i,horizontal:a,vertical:l},duration:e}})),s()},i=e=>{r&&(e.preventDefault(),r.end={x:e.touches[0].clientX,y:e.touches[0].clientY})};t.addEventListener("touchend",n),t.addEventListener("touchmove",i),t.addEventListener("touchcancel",o)}const f=e=>null!==e&&isFinite(e)&&!isNaN(e),p=new Set(["Script error.","ResizeObserver loop limit exceeded","ResizeObserver loop completed with undelivered notifications."]);class w{constructor(e){this._log={appId:String(e)}}build(){return Object.freeze(this._log)}withError(e){return e&&e instanceof Error?(this._log.error={},e.message&&(this._log.error.message=String(e.message)),e.name&&(this._log.error.name=String(e.name)),e.description&&(this._log.error.description=String(e.description)),f(e.number)&&(this._log.error.number=Number(e.number)),e.fileName&&(this._log.error.fileName=String(e.fileName)),f(e.lineNumber)&&(this._log.error.lineNumber=Number(e.lineNumber)),f(e.columnNumber)&&(this._log.error.columnNumber=Number(e.columnNumber)),e.stack&&(this._log.error.stack=String(e.stack)),this):this}withLegacyError(e,t,r,s){return this._log.legacyError={},e&&(this._log.legacyError.message=String(e)),t&&(this._log.legacyError.source=String(t)),f(r)&&(this._log.legacyError.lineno=Number(r)),f(s)&&(this._log.legacyError.colno=Number(s)),this}withLocation(){return window.location&&window.location.href&&(this._log.location=String(window.location.href)),this}withMessage(e){return e instanceof Object?this._log.message=JSON.stringify(e):e&&(this._log.message=String(e)),this}}class _{constructor(e,t,r){this._appId=e,this._logger=t,this._shouldThrottle=!!r&&!!r.shouldThrottle,this._uniqueLogs=new Map}error(e,t){this.errorBatch([{error:e,developerMessage:t}])}errorBatch(e){const t=e.map((({error:e,developerMessage:t})=>new w(this._appId).withError(e).withMessage(t).withLocation().build())).filter(this._throttle.bind(this));t.length>0&&this._logger.logBatch(t)}legacyError(e,t,r,s,o,n){this.legacyErrorBatch([{message:e,source:t,lineno:r,colno:s,error:o,developerMessage:n}])}legacyErrorBatch(e){const t=e.map((({message:e,source:t,lineno:r,colno:s,error:o,developerMessage:n})=>new w(this._appId).withLegacyError(e,t,r,s).withError(o).withMessage(n).withLocation().build())).filter(this._filterBenign).filter(this._throttle.bind(this));t.length>0&&this._logger.logBatch(t)}log(e){this.logBatch([e])}logBatch(e){const t=e.map((e=>new w(this._appId).withMessage(e).withLocation().build())).filter(this._throttle.bind(this));t.length>0&&this._logger.logBatch(t)}_filterBenign(e){if(e&&e.legacyError&&e.legacyError.message){return!p.has(e.legacyError.message)}return!0}_throttle(e){if(!this._shouldThrottle)return!0;const t=(new Date).getTime(),r=JSON.stringify(e),s=this._uniqueLogs.get(r);return(void 0===s||t-s>=6e4)&&(this._uniqueLogs.set(r,t),!0)}}const b=new class{constructor(e,t){this._batchSize=e,this._batchTime=t,this._logs=[],window.addEventListener("unload",this._onUnload.bind(this))}logBatch(e){for(clearTimeout(this._batchTimeout),this._loggerPromise=this._loggerPromise||this._provisionLoggerEndpoint(!1),this._logs=[...this._logs,...e];this._logs.length>=this._batchSize;){const e=this._logs.slice(0,this._batchSize);this._logs=this._logs.slice(this._batchSize,this._logs.length),this._log(e)}this._logs.length>0&&(this._batchTimeout=setTimeout((()=>{this._log(this._logs),this._logs=[]}),this._batchTime))}async _log(e){let t={method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)};try{let e=await this._loggerPromise;410===(await window.fetch(e.Endpoint,t)).status&&(this._loggerPromise=this._provisionLoggerEndpoint(!0),e=await this._loggerPromise,t={...t,mode:"no-cors"},window.fetch(e.Endpoint,t))}catch(t){console.error(t,e)}}async _onUnload(){if(clearTimeout(this._batchTimeout),(this._loggerPromise||navigator)&&navigator.sendBeacon&&this._logs.length>0)try{const e=await this._loggerPromise,t=JSON.stringify(this._logs);navigator.sendBeacon(e.Endpoint,t)}catch(e){console.error(e,this._logs)}}async _provisionLoggerEndpoint(e){const t=document.getElementsByTagName("html")[0];if(!t)throw new Error("Failed to locate top-level HTML element for data-logging-endpoint");const r=t.getAttribute("data-logging-endpoint");if(!r)throw new Error("Missing data-logging-endpoint attribute on top-level HTML element");return(await window.fetch(r,e?{cache:"reload"}:{})).json()}}(500,5e3);window.D2L=window.D2L||{},window.D2L.Intl={FormatNumber:e,FormatTime:r,ParseNumber:t,ParseTime:s},o.use({name:"auth",fn:n,options:{enableTokenCache:!0}}),o.use({name:"dedupe",fn:function(e,t){return d.dedupe(e,t)}}),o.use({name:"simple-cache",fn:function(e,t,r){return g.cache(e,t,r)}}),window.d2lfetch=o,window.D2L.Telemetry={Load:async function(){return(await import("./index6.js")).default},CreateClient:async function(){const e=await D2L.Telemetry.Load(),t=document.documentElement.getAttribute("data-telemetry-endpoint");if(null===t)throw new Error("Unable to create telemetry client, missing endpoint.");return new e.Client({endpoint:t})}},window.dispatchEvent(new CustomEvent("d2l-logging-loaded",{detail:{createClient:function(e,t){return new _(e,b,t)}}})),i(!1),window.D2L.Announce=a,window.D2L.Gestures=window.D2L.Gestures||{},window.D2L.Gestures.Swipe={register:function(e){e.addEventListener("touchstart",m)}},window.D2L.Dismissible={Clear:function(e){l(e)},Set:function(e){return c(e)}},window.D2L.Provider={provideInstance:h,requestInstance:u};
